trigger:
- main

variables:
  LOCATION: eastus
  RG_NAME: rg-dev-terraform
  ADMIN_USERNAME: azureuser
  # ADMIN_PASSWORD -> mark as SECRET in ADO
  # INFRACOST_API_KEY -> mark as SECRET in ADO

stages:

# =====================================================
# STAGE 1: PRE-COMMIT / STATIC & SECURITY ANALYSIS
# =====================================================
- stage: PreCommit
  displayName: 'Pre-Commit / Static & Security Analysis'
  jobs:
    - job: StaticSecurity
      displayName: 'Terraform Static & Security'
      pool:
        name: local-agent-pool

      steps:
        - checkout: self

        # Install Terraform
        - task: TerraformInstaller@1
          displayName: 'Install Terraform'
          inputs:
            terraformVersion: '1.6.6'

        # Terraform Init (NO BACKEND)
        - task: PowerShell@2
          displayName: 'Terraform Init (No Backend)'
          inputs:
            targetType: 'inline'
            script: |
              cd environments/dev
              terraform init -backend=false

        # Terraform Format Check
        - task: PowerShell@2
          displayName: 'Terraform Format Check'
          inputs:
            targetType: 'inline'
            script: |
              cd environments/dev
              terraform fmt -check -recursive

        # Terraform Validate
        - task: PowerShell@2
          displayName: 'Terraform Validate'
          inputs:
            targetType: 'inline'
            script: |
              cd environments/dev
              terraform validate

        # Checkov Security Scan (SOFT FAIL)
        - task: PowerShell@2
          displayName: 'Terraform Security Scan (Checkov)'
          continueOnError: true
          inputs:
            targetType: 'inline'
            script: |
              docker run --rm ^
                -v "$(System.DefaultWorkingDirectory):/tf" ^
                bridgecrew/checkov ^
                -d /tf/environments/dev ^
                --framework terraform

# =====================================================
# STAGE 2: COST & IMPACT ASSESSMENT (INFRACOST)
# =====================================================
- stage: Cost
  displayName: 'Cost & Impact Assessment (Infracost)'
  dependsOn: PreCommit
  condition: succeeded()

  jobs:
    - job: Infracost
      displayName: 'Infracost Cost Estimation'
      pool:
        name: local-agent-pool

      steps:
        - checkout: self

        - task: PowerShell@2
          displayName: 'Run Infracost Cost Breakdown'
          env:
            INFRACOST_API_KEY: $(INFRACOST_API_KEY)
          inputs:
            targetType: 'inline'
            script: |
              docker run --rm ^
                -e INFRACOST_API_KEY ^
                -v "$(System.DefaultWorkingDirectory):/tf" ^
                infracost/infracost ^
                breakdown --path /tf/environments/dev

# =====================================================
# STAGE 3: PLAN & REVIEW
# =====================================================
- stage: Plan
  displayName: 'Terraform Plan & Review'
  dependsOn: Cost
  condition: succeeded()

  jobs:
    - job: TerraformPlan
      displayName: 'Terraform Plan'
      pool:
        name: local-agent-pool

      steps:
        - checkout: self

        - task: TerraformInstaller@1
          displayName: 'Install Terraform'
          inputs:
            terraformVersion: '1.6.6'

        - task: TerraformTaskV4@4
          displayName: 'Terraform Init'
          inputs:
            provider: 'azurerm'
            command: 'init'
            workingDirectory: 'environments/dev'
            backendServiceArm: 'azure-terraform-conn'
            backendAzureRmResourceGroupName: 'rg-tf-backend'
            backendAzureRmStorageAccountName: 'tfstatemirhakim01'
            backendAzureRmContainerName: 'tfstate'
            backendAzureRmKey: 'dev.terraform.tfstate'
            commandOptions: '-reconfigure'

        - task: TerraformTaskV4@4
          displayName: 'Terraform Plan'
          inputs:
            provider: 'azurerm'
            command: 'plan'
            workingDirectory: 'environments/dev'
            environmentServiceNameAzureRM: 'azure-terraform-conn'
            commandOptions: >
              -input=false
              -var="location=$(LOCATION)"
              -var="rg_name=$(RG_NAME)"
              -var="admin_username=$(ADMIN_USERNAME)"
              -var="admin_password=$(ADMIN_PASSWORD)"

# =====================================================
# STAGE 4: APPLY (MANUAL APPROVAL REQUIRED)
# =====================================================
- stage: Apply
  displayName: 'Terraform Apply (Dev)'
  dependsOn: Plan
  condition: succeeded()

  jobs:
    - deployment: ApplyInfra
      displayName: 'Apply Terraform Infrastructure'
      environment: dev   # ðŸ” approval gate
      pool:
        name: local-agent-pool

      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: self

              - task: TerraformTaskV4@4
                displayName: 'Terraform Init (Apply)'
                inputs:
                  provider: 'azurerm'
                  command: 'init'
                  workingDirectory: 'environments/dev'
                  backendServiceArm: 'azure-terraform-conn'
                  backendAzureRmResourceGroupName: 'rg-tf-backend'
                  backendAzureRmStorageAccountName: 'tfstatemirhakim01'
                  backendAzureRmContainerName: 'tfstate'
                  backendAzureRmKey: 'dev.terraform.tfstate'
                  commandOptions: '-reconfigure'

              - task: TerraformTaskV4@4
                displayName: 'Terraform Apply'
                inputs:
                  provider: 'azurerm'
                  command: 'apply'
                  workingDirectory: 'environments/dev'
                  environmentServiceNameAzureRM: 'azure-terraform-conn'
                  commandOptions: >
                    -auto-approve
                    -input=false
                    -var="location=$(LOCATION)"
                    -var="rg_name=$(RG_NAME)"
                    -var="admin_username=$(ADMIN_USERNAME)"
                    -var="admin_password=$(ADMIN_PASSWORD)"
