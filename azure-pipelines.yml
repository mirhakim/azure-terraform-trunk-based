trigger:
- main

variables:
  LOCATION: eastus
  RG_NAME: rg-dev-terraform
  ADMIN_USERNAME: azureuser
  # ADMIN_PASSWORD must be stored as SECRET in pipeline variables

stages:

# =====================================================
# STAGE 1: PRE-COMMIT / STATIC & SECURITY ANALYSIS
# =====================================================
- stage: PreCommit_Static
  displayName: 'Pre-Commit / Static & Security Analysis'
  jobs:
    - job: StaticAnalysis
      displayName: 'Terraform Static & Security'
      pool:
        name: local-agent-pool

      steps:
        - checkout: self

        # Install Terraform
        - task: TerraformInstaller@1
          displayName: 'Install Terraform'
          inputs:
            terraformVersion: '1.6.6'

        # Terraform Init (NO backend)
        - script: |
            terraform init -backend=false
          workingDirectory: environments/dev
          displayName: 'Terraform Init (No Backend)'

        # Terraform Format Check
        - script: |
            terraform fmt -check -recursive
          workingDirectory: environments/dev
          displayName: 'Terraform Format Check'

        # Terraform Validate
        - script: |
            terraform validate
          workingDirectory: environments/dev
          displayName: 'Terraform Validate'

        # Terraform Security Scan - Checkov (Docker, Windows-safe)
        - script: |
            docker run --rm -v "%BUILD_SOURCESDIRECTORY%:/tf" bridgecrew/checkov -d /tf/environments/dev --framework terraform --soft-fail
          displayName: 'Terraform Security Scan (Checkov)'

# =====================================================
# STAGE 2: COST & IMPACT ASSESSMENT (INFRACOST)
# =====================================================
- stage: Cost_Assessment
  displayName: 'Cost & Impact Assessment (Infracost)'
  dependsOn: PreCommit_Static
  condition: succeeded()

  jobs:
    - job: Infracost
      displayName: 'Infracost Cost Estimation'
      pool:
        name: local-agent-pool

      steps:
        - checkout: self

        - script: |
            docker run --rm ^
              -e INFRACOST_API_KEY=%INFRACOST_API_KEY% ^
              -v "%BUILD_SOURCESDIRECTORY%:/workspace" ^
              infracost/infracost breakdown ^
              --path /workspace/environments/dev ^
              --format table
          displayName: 'Run Infracost Cost Breakdown'
          env:
          INFRACOST_API_KEY: $(INFRACOST_API_KEY)


# =====================================================
# STAGE 3: PLAN & REVIEW (REAL BACKEND)
# =====================================================
- stage: Plan
  displayName: 'Terraform Plan & Review'
  dependsOn: Cost_Assessment
  condition: succeeded()

  jobs:
    - job: TerraformPlan
      displayName: 'Terraform Plan'
      pool:
        name: local-agent-pool

      steps:
        - checkout: self

        - task: TerraformInstaller@1
          displayName: 'Install Terraform'
          inputs:
            terraformVersion: '1.6.6'

        # Terraform Init WITH backend
        - task: TerraformTaskV4@4
          displayName: 'Terraform Init (Backend)'
          inputs:
            provider: 'azurerm'
            command: 'init'
            workingDirectory: 'environments/dev'
            backendServiceArm: 'azure-terraform-conn'
            backendAzureRmResourceGroupName: 'rg-tf-backend'
            backendAzureRmStorageAccountName: 'tfstatemirhakim01'
            backendAzureRmContainerName: 'tfstate'
            backendAzureRmKey: 'dev.terraform.tfstate'
            commandOptions: '-reconfigure'

        # Terraform Plan
        - task: TerraformTaskV4@4
          displayName: 'Terraform Plan'
          inputs:
            provider: 'azurerm'
            command: 'plan'
            workingDirectory: 'environments/dev'
            environmentServiceNameAzureRM: 'azure-terraform-conn'
            commandOptions: >
              -input=false
              -var="location=$(LOCATION)"
              -var="rg_name=$(RG_NAME)"
              -var="admin_username=$(ADMIN_USERNAME)"
              -var="admin_password=$(ADMIN_PASSWORD)"


# =====================================================
# STAGE 4: APPLY (MANUAL APPROVAL REQUIRED)
# =====================================================
- stage: Apply
  displayName: 'Terraform Apply (Dev)'
  dependsOn: Plan
  condition: succeeded()

  jobs:
    - deployment: ApplyInfra
      displayName: 'Apply Terraform Infrastructure'
      environment: dev   # ðŸ” Environment approval gate
      pool:
        name: local-agent-pool

      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: self

              # Terraform Init again (REQUIRED)
              - task: TerraformTaskV4@4
                displayName: 'Terraform Init (Apply)'
                inputs:
                  provider: 'azurerm'
                  command: 'init'
                  workingDirectory: 'environments/dev'
                  backendServiceArm: 'azure-terraform-conn'
                  backendAzureRmResourceGroupName: 'rg-tf-backend'
                  backendAzureRmStorageAccountName: 'tfstatemirhakim01'
                  backendAzureRmContainerName: 'tfstate'
                  backendAzureRmKey: 'dev.terraform.tfstate'
                  commandOptions: '-reconfigure'

              # Terraform Apply
              - task: TerraformTaskV4@4
                displayName: 'Terraform Apply'
                inputs:
                  provider: 'azurerm'
                  command: 'apply'
                  workingDirectory: 'environments/dev'
                  environmentServiceNameAzureRM: 'azure-terraform-conn'
                  commandOptions: >
                    -auto-approve
                    -input=false
                    -var="location=$(LOCATION)"
                    -var="rg_name=$(RG_NAME)"
                    -var="admin_username=$(ADMIN_USERNAME)"
                    -var="admin_password=$(ADMIN_PASSWORD)"
