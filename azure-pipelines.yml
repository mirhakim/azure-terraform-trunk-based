trigger:
- main

variables:
  ENV_PATH: environments/dev

stages:

# ============================================================
# STAGE 1: PRE-COMMIT / STATIC & SECURITY ANALYSIS
# ============================================================
- stage: PreCommit
  displayName: 'Pre-Commit / Static & Security Analysis'
  jobs:
  - job: StaticSecurity
    displayName: 'Terraform Static & Security'
    pool:
      name: linux-hosted-agent
    steps:
    - checkout: self

    - bash: |
        terraform --version
      displayName: 'Verify Terraform'

    - bash: |
        cd $(ENV_PATH)
        terraform init -backend=false
      displayName: 'Terraform Init (No Backend)'

    - bash: |
        cd $(ENV_PATH)
        terraform fmt -check
      displayName: 'Terraform Format Check'

    - bash: |
        cd $(ENV_PATH)
        terraform validate
      displayName: 'Terraform Validate'


# ============================================================
# STAGE 2: COST & IMPACT ASSESSMENT (INFRACOST)
# ============================================================
- stage: Cost
  displayName: 'Cost & Impact Assessment (Infracost)'
  dependsOn: PreCommit
  condition: succeeded()
  jobs:
  - job: Infracost
    displayName: 'Infracost Cost Estimation'
    pool:
      name: linux-hosted-agent
    steps:
    - checkout: self

    - bash: |
        docker --version
      displayName: 'Verify Docker'

    - bash: |
        if [ -z "$INFRACOST_API_KEY" ]; then
          echo "❌ INFRACOST_API_KEY not set"
          exit 1
        fi
        echo "✅ INFRACOST_API_KEY detected"
      displayName: 'Verify Infracost API Key'

    - bash: |
        cd $(ENV_PATH)
        terraform init -backend=false
        docker run --rm \
          -e INFRACOST_API_KEY=$INFRACOST_API_KEY \
          -v $(pwd):/workspace \
          infracost/infracost breakdown \
          --path /workspace \
          --format table
      displayName: 'Run Infracost Cost Breakdown'


# ============================================================
# STAGE 3: TERRAFORM PLAN (DEV)
# ============================================================
- stage: Plan
  displayName: 'Terraform Plan (Dev)'
  dependsOn: Cost
  condition: succeeded()
  jobs:
  - job: TerraformPlan
    displayName: 'Terraform Plan'
    pool:
      name: linux-hosted-agent
    steps:
    - checkout: self

    - bash: |
        cd $(ENV_PATH)
        terraform init
      displayName: 'Terraform Init (With Backend)'

    - bash: |
        cd $(ENV_PATH)
        terraform plan -out=tfplan
      displayName: 'Terraform Plan'
