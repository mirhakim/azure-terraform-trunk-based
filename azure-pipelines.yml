trigger:
- main

variables:
  LOCATION: eastus
  RG_NAME: rg-dev-terraform
  ADMIN_USERNAME: azureuser
  # ADMIN_PASSWORD must be stored as SECRET in Azure DevOps pipeline variables

stages:

# =====================================================
# STAGE 0: PRE-COMMIT / STATIC ANALYSIS (CI)
# =====================================================
- stage: PreCommit_Static
  displayName: 'Pre-Commit / Static Analysis'
  jobs:
    - job: StaticChecks
      displayName: 'Terraform Static & Security Checks'
      pool:
        name: local-agent-pool
      steps:
        - checkout: self

        # Install Terraform
        - task: TerraformInstaller@1
          displayName: 'Install Terraform'
          inputs:
            terraformVersion: '1.6.6'

        # Terraform Init (NO backend, CI safe)
        - task: TerraformTaskV4@4
          displayName: 'Terraform Init (Pre-Commit)'
          inputs:
            provider: 'azurerm'
            command: 'init'
            workingDirectory: 'environments/dev'
            commandOptions: '-backend=false'

        # Terraform Format Check
        - script: |
            terraform fmt -check -recursive environments/dev
          displayName: 'Terraform Format Check'

        # Terraform Validate
        - task: TerraformTaskV4@4
          displayName: 'Terraform Validate'
          inputs:
            provider: 'azurerm'
            command: 'validate'
            workingDirectory: 'environments/dev'

        # DevSecOps Security Scan (Checkov)
        - script: |
            python -m pip install --upgrade pip
            pip install checkov
            checkov -d environments/dev --framework terraform
          displayName: 'Terraform Security Scan (Checkov)'

# =====================================================
# STAGE 1: PLAN & REVIEW
# =====================================================
- stage: Plan
  displayName: 'Terraform Plan & Review'
  dependsOn: PreCommit_Static
  condition: succeeded()
  jobs:
    - job: TerraformPlan
      displayName: 'Terraform Plan'
      pool:
        name: local-agent-pool
      steps:
        - checkout: self

        # Install Terraform
        - task: TerraformInstaller@1
          displayName: 'Install Terraform'
          inputs:
            terraformVersion: '1.6.6'

        # Terraform Init (REMOTE backend)
        - task: TerraformTaskV4@4
          displayName: 'Terraform Init'
          inputs:
            provider: 'azurerm'
            command: 'init'
            workingDirectory: 'environments/dev'
            backendServiceArm: 'azure-terraform-conn'
            backendAzureRmResourceGroupName: 'rg-tf-backend'
            backendAzureRmStorageAccountName: 'tfstatemirhakim01'
            backendAzureRmContainerName: 'tfstate'
            backendAzureRmKey: 'dev.terraform.tfstate'
            commandOptions: '-reconfigure'

        # Terraform Plan
        - task: TerraformTaskV4@4
          displayName: 'Terraform Plan'
          inputs:
            provider: 'azurerm'
            command: 'plan'
            workingDirectory: 'environments/dev'
            environmentServiceNameAzureRM: 'azure-terraform-conn'
            commandOptions: >
              -input=false
              -var="location=$(LOCATION)"
              -var="rg_name=$(RG_NAME)"
              -var="admin_username=$(ADMIN_USERNAME)"
              -var="admin_password=$(ADMIN_PASSWORD)"

# =====================================================
# STAGE 2: APPLY (CD â€“ APPROVAL REQUIRED)
# =====================================================
- stage: Apply
  displayName: 'Terraform Apply (Dev)'
  dependsOn: Plan
  condition: succeeded()
  jobs:
    - deployment: ApplyInfra
      displayName: 'Apply Terraform Infrastructure'
      environment: dev   # ðŸ” Manual approval + governance
      pool:
        name: local-agent-pool
      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: self

              # Terraform Init (required again)
              - task: TerraformTaskV4@4
                displayName: 'Terraform Init (Apply)'
                inputs:
                  provider: 'azurerm'
                  command: 'init'
                  workingDirectory: 'environments/dev'
                  backendServiceArm: 'azure-terraform-conn'
                  backendAzureRmResourceGroupName: 'rg-tf-backend'
                  backendAzureRmStorageAccountName: 'tfstatemirhakim01'
                  backendAzureRmContainerName: 'tfstate'
                  backendAzureRmKey: 'dev.terraform.tfstate'
                  commandOptions: '-reconfigure'

              # Terraform Apply
              - task: TerraformTaskV4@4
                displayName: 'Terraform Apply'
                inputs:
                  provider: 'azurerm'
                  command: 'apply'
                  workingDirectory: 'environments/dev'
                  environmentServiceNameAzureRM: 'azure-terraform-conn'
                  commandOptions: >
                    -auto-approve
                    -input=false
                    -var="location=$(LOCATION)"
                    -var="rg_name=$(RG_NAME)"
                    -var="admin_username=$(ADMIN_USERNAME)"
                    -var="admin_password=$(ADMIN_PASSWORD)"
