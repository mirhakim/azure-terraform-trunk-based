trigger:
- main

############################################
# VARIABLE GROUP (MANDATORY)
############################################
variables:
- group: infracost-secrets

############################################
# STAGE 1: PRE-COMMIT / STATIC & SECURITY
############################################
stages:
- stage: PreCommit
  displayName: 'Pre-Commit / Static & Security Analysis'
  jobs:
  - job: StaticSecurity
    displayName: 'Terraform Static & Security'
    pool:
      name: linux-hosted-agent   # <-- your self-hosted agent pool
    steps:
    - checkout: self

    - bash: |
        terraform --version
      displayName: 'Verify Terraform'

    - bash: |
        terraform fmt -check
      displayName: 'Terraform Format Check'

    - bash: |
        terraform validate
      displayName: 'Terraform Validate'

############################################
# STAGE 2: COST & IMPACT ASSESSMENT (INFRACOST)
############################################
- stage: Cost
  displayName: 'Cost & Impact Assessment (Infracost)'
  dependsOn: PreCommit
  condition: succeeded()
  jobs:
  - job: Infracost
    displayName: 'Infracost Cost Estimation'
    pool:
      name: linux-hosted-agent
    steps:
    - checkout: self

    # ðŸ” DEBUG â€“ Confirm API key is injected
    - bash: |
        echo "INFRACOST_API_KEY length: ${#INFRACOST_API_KEY}"
        if [ -z "$INFRACOST_API_KEY" ]; then
          echo "âŒ API KEY NOT AVAILABLE"
          exit 1
        else
          echo "âœ… API KEY AVAILABLE"
        fi
      displayName: 'DEBUG â€“ Verify Infracost API Key'

    # ðŸ³ Verify Docker
    - bash: |
        docker --version
        docker ps
      displayName: 'Verify Docker'

    # ðŸ’° Run Infracost
    - bash: |
        docker run --rm \
          -e INFRACOST_API_KEY=$INFRACOST_API_KEY \
          -v $(pwd):/workspace \
          infracost/infracost breakdown \
          --path /workspace/environments/dev \
          --format table
      displayName: 'Run Infracost Cost Breakdown'

############################################
# STAGE 3: TERRAFORM PLAN
############################################
- stage: Plan
  displayName: 'Terraform Plan (Dev)'
  dependsOn: Cost
  condition: succeeded()
  jobs:
  - job: TerraformPlan
    displayName: 'Terraform Plan'
    pool:
      name: linux-hosted-agent
    steps:
    - checkout: self

    - bash: |
        cd environments/dev
        terraform init
        terraform plan
      displayName: 'Terraform Init & Plan'
