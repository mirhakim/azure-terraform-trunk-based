trigger:
- main

variables:
  LOCATION: eastus
  RG_NAME: rg-dev-terraform
  ADMIN_USERNAME: azureuser
  # ADMIN_PASSWORD is stored as secret in pipeline UI

stages:

# ---------------- CI STAGE ----------------
- stage: Plan
  displayName: 'Terraform Plan (Dev)'
  jobs:
    - job: TerraformPlan
      displayName: 'Terraform Plan'
      pool:
        name: local-agent-pool
      steps:
        - checkout: self

        - task: TerraformInstaller@1
          displayName: 'Install Terraform'
          inputs:
            terraformVersion: '1.6.6'

        - task: TerraformTaskV4@4
          displayName: 'Terraform Init'
          inputs:
            provider: 'azurerm'
            command: 'init'
            workingDirectory: 'environments/dev'
            backendServiceArm: 'azure-terraform-conn'
            backendAzureRmResourceGroupName: 'rg-tf-backend'
            backendAzureRmStorageAccountName: 'tfstatemirhakim01'
            backendAzureRmContainerName: 'tfstate'
            backendAzureRmKey: 'dev.terraform.tfstate'
            commandOptions: '-reconfigure'

        - task: TerraformTaskV4@4
          displayName: 'Terraform Validate'
          inputs:
            provider: 'azurerm'
            command: 'validate'
            workingDirectory: 'environments/dev'

        - task: TerraformTaskV4@4
          displayName: 'Terraform Plan'
          inputs:
            provider: 'azurerm'
            command: 'plan'
            workingDirectory: 'environments/dev'
            environmentServiceNameAzureRM: 'azure-terraform-conn'
            commandOptions: >
              -input=false
              -var="location=$(LOCATION)"
              -var="rg_name=$(RG_NAME)"
              -var="admin_username=$(ADMIN_USERNAME)"
              -var="admin_password=$(ADMIN_PASSWORD)"

# ---------------- CD STAGE ----------------
- stage: Apply
  displayName: 'Terraform Apply (Dev)'
  dependsOn: Plan
  condition: succeeded()
  jobs:
    - deployment: ApplyInfra
      displayName: 'Apply Terraform Infra'
      environment: dev
      pool:
        name: local-agent-pool
      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: self

              # ðŸ”‘ REQUIRED INIT AGAIN
              - task: TerraformTaskV4@4
                displayName: 'Terraform Init (Apply)'
                inputs:
                  provider: 'azurerm'
                  command: 'init'
                  workingDirectory: 'environments/dev'
                  backendServiceArm: 'azure-terraform-conn'
                  backendAzureRmResourceGroupName: 'rg-tf-backend'
                  backendAzureRmStorageAccountName: 'tfstatemirhakim01'
                  backendAzureRmContainerName: 'tfstate'
                  backendAzureRmKey: 'dev.terraform.tfstate'
                  commandOptions: '-reconfigure'

              - task: TerraformTaskV4@4
                displayName: 'Terraform Apply'
                inputs:
                  provider: 'azurerm'
                  command: 'apply'
                  workingDirectory: 'environments/dev'
                  environmentServiceNameAzureRM: 'azure-terraform-conn'
                  commandOptions: >
                    -auto-approve
                    -input=false
                    -var="location=$(LOCATION)"
                    -var="rg_name=$(RG_NAME)"
                    -var="admin_username=$(ADMIN_USERNAME)"
                    -var="admin_password=$(ADMIN_PASSWORD)"
