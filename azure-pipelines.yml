trigger:
- none   # manual run only

stages:
- stage: Cost
  displayName: 'TEST – Infracost API & Docker Validation'

  jobs:
  - job: InfracostTest
    displayName: 'Infracost Debug Job'

    pool:
      name: linux-hosted-agent   # your self-hosted Linux agent

    steps:
    - checkout: self

    # --------------------------------------------------
    # DEBUG 1: Check API key visibility
    # --------------------------------------------------
    - bash: |
        echo "=== DEBUG: Checking API key ==="
        echo "INFRACOST_API_KEY length: ${#INFRACOST_API_KEY}"
        if [ -z "$INFRACOST_API_KEY" ]; then
          echo "❌ API KEY NOT AVAILABLE"
          exit 1
        else
          echo "✅ API KEY IS AVAILABLE"
        fi
      displayName: 'DEBUG – Verify Infracost API Key'

    # --------------------------------------------------
    # DEBUG 2: Check Docker
    # --------------------------------------------------
    - bash: |
        echo "=== DEBUG: Docker version ==="
        docker --version
        docker ps
      displayName: 'DEBUG – Verify Docker'

    # --------------------------------------------------
    # TEST 3: Run Infracost (REAL TEST)
    # --------------------------------------------------
    - bash: |
        echo "=== Running Infracost Cost Breakdown ==="
        docker run --rm \
          -e INFRACOST_API_KEY="$INFRACOST_API_KEY" \
          -v "$(pwd)/environments/dev:/tf" \
          infracost/infracost breakdown \
          --path /tf \
          --format table
      displayName: 'TEST – Run Infracost Cost Breakdown'
